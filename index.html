<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>YouTube to MP3 (N√¢ng c·∫•p)</title>
<style>
    html, body {
      margin: 0; padding: 0; min-height: 100vh;
      background: linear-gradient(to right, #232526, #4ca1af); color: #fff;
    }
    body { font-family: 'Segoe UI', Arial, sans-serif; }
    .container {
      background: rgba(10,20,40,0.58);
      border-radius: 13px;
      max-width: 880px;
      margin: 24px auto 0 auto;
      box-shadow: 0 3px 20px 0 #0e27346a;
      padding: 0 0 14px 0;
      width: 97vw;
      min-height: 80vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .header-box {
      width: 100%;
      background: rgba(22,27,38,0.98);
      border-radius: 13px 13px 0 0;
      box-shadow: 0 2px 18px 0 #0002;
      padding: 5px 0 3px 0;
      display: flex; flex-direction: column; align-items: center;
    }
    .title-app {
      font-size: 19px;
      margin-bottom: 4px; font-weight: 600;
      letter-spacing: 0.2px;
      text-shadow: 0 1px 7px #212d3a66;
      text-align: center;
    }
    .desc-app {
      font-size: 13px;
      margin-bottom: 13px;
      color:#d1eeff;
      text-align: center;
      padding: 0 14px;
    }
    .search-row {
      display: flex; justify-content: center; align-items: center;
      gap: 5px;
      margin-bottom: 0; margin-top: 0;
      width: 99vw; max-width: 420px;
    }
    .search-input {
      padding: 8px 7px 8px 7px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      min-width: 40px;
      max-width: 220px;
      background: #1e2a3c;
      color: #fff;
      flex: 1 1 0%;
      outline: none; margin: 0;
      transition: box-shadow 0.15s;
    }
    .paste-btn, .download-btn, .search-btn {
      min-width: unset;
      width: auto;
      padding: 7px 12px;
      font-size: 13px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .paste-btn { background-color: #2980b9; color: #fff; }
    .paste-btn:hover { background-color: #3498db;}
    .search-btn { background-color: #6c4ad9; color: white; }
    .search-btn:hover { background-color: #8257e6;}
    .download-btn { background-color: #27ae60; color: white; }
    .download-btn:hover { background-color: #2ecc71;}
    .input-error {
      color: #ffcdd2; background: #38040d33; border-radius: 3px;
      font-size: 12px; padding: 2px 0 2px 0; margin: 5px 18px 3px 18px;
      min-height: 18px; text-align: left; text-indent: 6px;
    }
    .main-content-row {
      display: flex; flex-direction: row; gap: 30px;
      width: 100%; justify-content: center;
      margin-top: 18px; flex: 1 1 auto;
      min-height: 60vh;
    }
    .video-list-col, .task-list-col {
      flex: 1 1 0; min-width: 300px; max-width: 400px;
      display: flex; flex-direction: column; align-items: stretch;
    }
    .video-list-col { align-items: flex-start; }
    .task-list-col { align-items: flex-end; }
    .search-results-title {
      font-size: 14px; margin: 6px 0 7px 8px; font-weight: 600; color: #96f7fa;
      letter-spacing: 0.3px;
    }
    .video-result-list {
      list-style: none; margin: 0; padding: 0; width: 100%;
    }
    .video-result-item {
      display: flex; align-items: center; gap: 10px;
      background: rgba(30,44,66,0.36);
      border-radius: 6px; margin-bottom: 9px; padding: 6px 9px 6px 7px;
      transition: box-shadow 0.13s, background 0.11s;
      border: 1px solid #21436a1a;
      position: relative;
      min-height: 38px;
    }
    .video-result-thumb {
      width: 64px; height: 38px; object-fit: cover; border-radius: 5px;
      background: #1c2737; flex-shrink: 0; border: 1px solid #234052;
      margin-right: 6px;
    }
    .video-result-info { flex: 1 1 auto; }
    .video-result-title {
      font-size: 13.3px; font-weight: 500; color: #e2fdff;
      margin: 0 0 2px 0; word-break: break-word; line-height: 1.25;
      display: block;
    }
    .video-result-duration {
      font-size: 12px; color: #e6d18b;
      margin-top: 0; margin-right: 4px;
    }
    .video-result-download {
      margin-left: 11px;
    }
    .tasklist {
      margin: 0;
      width: 100%;
    }
    .task {
      background: rgba(255,255,255,0.07);
      margin-bottom: 7px;
      padding: 4px 7px 3px 7px;
      border-radius: 6px;
      font-size: 13.2px;
      border: 1px solid #394c5799;
      display: flex;
      flex-direction: column;
      box-shadow: 0 1px 5px 0 #101e3d11;
      position: relative;
      min-height: 35px;
      gap: 0;
      transition: box-shadow 0.16s;
      max-width: 410px;
      align-self: flex-end;
    }
    .task:hover { box-shadow: 0 2px 10px 0 #285b7042; }
    .task-row {
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 5px;
      margin-bottom: 0px;
      min-height: 18px;
    }
    .task-number {
      font-weight: 600;
      color: #53b2e7;
      font-size: 13.4px;
      margin-right: 2px;
      flex-shrink: 0;
      margin-top: 3px;
    }
    .video-title {
      color: #ffe082;
      font-size: 13.2px;
      font-weight: 500;
      margin: 0 3px 0 0;
      text-align: left;
      word-break: break-word;
      flex: 1 1 auto;
      min-width: 0;
      line-height: 1.32;
      display: block;
      margin-top: 1px;
    }
    .video-title a { color: #b6d6ff; text-decoration: none; transition: color 0.2s; word-break: break-word; line-height: 1.33; }
    .video-title a:hover { color: #39d3ff; text-decoration: underline;}
    .video-duration {
      font-size: 12px; color: #7ec5e6; margin-left: 4px; margin-top: 3px;
      flex-shrink: 0; font-weight: 400; min-width: 34px; text-align: right;
    }
    .progress {
      height: 5px;
      background: #364050;
      border-radius: 3px;
      overflow: hidden;
      margin: 2px 0 2px 0;
      width: 100%;
      box-shadow: 0 0 1px 0 #24395e44;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #4efbb6 45%, #ffe566 85%);
      transition: width 0.3s;
      border-radius: 3px;
    }
    .task-action-row {
      display: flex; flex-direction: row; align-items: center; justify-content: flex-end;
      gap: 8px; margin-top: 2px;
    }
    .task-status-txt {
      font-size: 12px;
      color: #ffe582;
      margin-left: 2px;
      font-weight: 400;
      flex: 1 1 auto;
      text-align: left;
      margin-bottom: 1px;
      margin-right: 6px;
      line-height: 1.23;
      word-break: break-word;
      max-width: 55vw;
      min-width: 32px;
    }
    .main-btn {
      min-width: 90px;
      background: #237abb;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 12.6px;
      padding: 5px 0;
      cursor: pointer;
      text-align: center;
      font-weight: 500;
      margin-top: 0px;
      margin-bottom: 0;
      transition: background 0.16s;
      line-height: 1.2;
    }
    .task-title {
      font-size: 14px;
      margin: 6px 0 7px 8px;
      font-weight: 600;
      color: #ffde80;
      letter-spacing: 0.3px;
    }
    .video-warn {
      min-height: 16px;
    }
    .video-result-download svg { vertical-align: middle; }

    .main-btn:hover { background: #36b4e3; }
    .main-btn.done { background: #6cd883; color: #fff; cursor: default;}
    .main-btn.error { background: #ee5e52; color: #fff; cursor: default;}
    .main-btn.cancel { background: #b2576d; color: #fff;}
    .download-link { color: #00ffcc; text-decoration: none; font-weight: bold;}
    @media (max-width: 850px) {
      .container { max-width: 99vw; }
      .main-content-row { flex-direction: column; gap: 12px; align-items: center;}
      .video-list-col, .task-list-col { max-width: 99vw; min-width: 0; width: 97vw;}
      .task { max-width: 99vw;}
    }
    @media (max-width: 480px) {
      .search-row { max-width: 99vw; }
      .container { max-width: 99vw; }
      .video-list-col, .task-list-col { min-width: 0; }
      .desc-app { padding: 0 3vw; }
      .video-title { font-size: 12.3px;}
      .task-status-txt { max-width: 33vw;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-box">
      <div class="title-app">üéµ YouTube to MP3</div>
      <div class="desc-app">Trang web ƒë∆∞·ª£c t·∫°o ng√†y 20/6/2025 b·ªüi Takeshi & Gemini - c18/e1/f324</div>
      <div class="search-row">
        <button type="button" class="paste-btn" onclick="pasteClipboard()" title="D√°n nhanh">üìã</button>
        <input type="text" class="search-input" id="url" placeholder="Nh·∫≠p t·ª´ kh√≥a, link video ho·∫∑c playlist...">
        <button class="search-btn" onclick="searchVideo()">T√¨m ki·∫øm</button>
        <button class="download-btn" onclick="addTask()">T·∫£i link</button>
      </div>
      <div id="inputError" class="input-error"></div>
    </div>
    <div class="main-content-row">
      <div class="video-list-col">
        <div class="search-results-title" id="searchResultsTitle" style="display:none">K·∫øt qu·∫£ t√¨m ki·∫øm</div>
        <ul class="video-result-list" id="searchResults"></ul>
      </div>
      <div class="task-list-col">
        <div class="tasklist" id="taskList"></div>
      </div>
    </div>
  </div>

  <script>
  let tasks = [];
  const API_URL = 'http://api.takeshi.dev'; // Thay b·∫±ng URL API th·∫≠t c·ªßa b·∫°n
  const WS_URL = 'ws://tomp3.takeshi.dev';   // Thay b·∫±ng URL WebSocket th·∫≠t c·ªßa b·∫°n

  // ======================== 1. THI·∫æT L·∫¨P WEBSOCKET ========================
  const socket = new WebSocket(WS_URL);

  socket.onopen = () => {
    console.log('‚úÖ WebSocket Connected!');
    showInputError('');
  };

  socket.onclose = () => {
    console.error('‚ùå WebSocket Disconnected!');
    showInputError('M·∫•t k·∫øt n·ªëi t·ªõi server, vui l√≤ng t·∫£i l·∫°i trang.');
  };

  socket.onerror = (error) => {
    console.error('WebSocket Error:', error);
    showInputError('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server.');
  };

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    console.log('Received from server:', data);

    if (data.type === 'playlist_items') {
      handlePlaylistItems(data.items);
      return;
    }

    if (data.type === 'status_update') {
      const task = tasks.find(t => t.url === data.url);
      if (!task) return;

      // C·∫≠p nh·∫≠t th√¥ng tin task
      task.status = data.status;
      if (data.title) task.title = data.title;
      if (data.duration) task.duration = data.duration;
      if (data.statusMsg) task.statusMsg = data.statusMsg;
      if (data.errorMsg) task.errorMsg = data.errorMsg;

      if (data.status === 'processing') {
        task.progress = data.progress || task.progress;
      } else if (data.status === 'done') {
        task.progress = 100;
        task.link = API_URL + data.downloadLink;
        task.finishTime = Date.now();
      } else if (data.status === 'error') {
        task.progress = 100; // ƒê·ªÉ thanh progress ƒë·∫ßy v√† c√≥ m√†u ƒë·ªè
      }
      updateUI();
    }
  };

  // ======================== 2. X·ª¨ L√ù PLAYLIST ========================
  function handlePlaylistItems(items) {
    showInputError('');
    if (!items || items.length === 0) {
      showInputError('Playlist r·ªóng ho·∫∑c kh√¥ng h·ª£p l·ªá.');
      return;
    }
    // D√πng m·ªôt ch√∫t delay ƒë·ªÉ th√™m task t·ª´ t·ª´, tr√°nh spam UI
    items.forEach((item, index) => {
        setTimeout(() => {
            // Ch·ªâ th√™m n·∫øu ch∆∞a c√≥ trong danh s√°ch
            if (!tasks.some(t => t.url === item.url)) {
                 addTask(item.url, true); // Th√™m flag ƒë·ªÉ bi·∫øt ƒë√¢y l√† t·ª´ playlist
            }
        }, index * 200);
    });
  }

  // ======================== 3. LOGIC C≈® ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T ========================
  // H√†m addTask gi·ªù ch·ªâ g·ª≠i y√™u c·∫ßu, kh√¥ng c√≤n polling
  async function addTask(urlParam, fromPlaylist = false) {
    clearInputError();
    const urlInput = document.getElementById('url');
    const url = urlParam ? urlParam : urlInput.value.trim();

    if (!url) { showInputError('Vui l√≤ng nh·∫≠p link!'); return; }
    if (!fromPlaylist && !isValidYoutubeURL(url)) { showInputError('Vui l√≤ng nh·∫≠p ƒë√∫ng link YouTube!'); return; }
    if (tasks.some(t => t.url === url)) { showInputError('Link n√†y ƒë√£ c√≥ trong danh s√°ch!'); return; }
    if (getProcessingTaskCount() >= 5) { showInputError('Ch·ªâ ƒë∆∞·ª£c t·∫£i t·ªëi ƒëa 5 link c√πng l√∫c. Vui l√≤ng ch·ªù!'); return; }

    if (!urlParam) urlInput.value = '';

    const task = {
      url,
      title: 'ƒêang ch·ªù th√¥ng tin t·ª´ server...',
      duration: '',
      status: 'processing',
      progress: 2,
      link: null,
      downloaded: false,
      statusMsg: 'ƒêang g·ª≠i y√™u c·∫ßu...',
      errorMsg: null,
      startTime: Date.now(),
      finishTime: null
    };
    tasks.push(task);
    updateUI();

    try {
        const res = await fetch(`${API_URL}/download`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
        });
        if (!res.ok && res.status !== 202) { // 202 l√† status "Accepted"
            const errorData = await res.json();
            task.status = 'error';
            task.errorMsg = errorData.error || `L·ªói HTTP ${res.status}`;
            updateUI();
        }
    } catch (err) {
        task.status = 'error';
        task.errorMsg = 'L·ªói k·∫øt n·ªëi t·ªõi server!';
        updateUI();
    }
  }

  // To√†n b·ªô c√°c h√†m helper kh√°c (updateUI, searchVideo, secondsToHMS, etc.)
  // v·ªÅ c∆° b·∫£n ƒë∆∞·ª£c gi·ªØ nguy√™n. updateUI v·∫´n l√† tr√°i tim c·ªßa vi·ªác hi·ªÉn th·ªã.
  // B·∫°n ch·ªâ c·∫ßn copy v√† paste to√†n b·ªô c√°c h√†m c√≤n l·∫°i t·ª´ file g·ªëc v√†o ƒë√¢y.
  
  function isValidYoutubeURL(url) { return /^(https?\:\/\/)?(www\.|m\.)?(youtube\.com|youtu\.be)\/.+$/i.test(url); }
  function showInputError(msg) { document.getElementById('inputError').textContent = msg || ''; }
  function clearInputError() { showInputError(''); }
  function getProcessingTaskCount() { return tasks.filter(t => t.status === 'processing').length; }
  async function pasteClipboard() { try { const text = await navigator.clipboard.readText(); document.getElementById('url').value = text; } catch (err) { alert('Kh√¥ng th·ªÉ d√°n.'); } }
  function secondsToHMS(seconds) { if (!seconds || isNaN(seconds)) return ''; const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60); const s = Math.floor(seconds % 60); if (h > 0) return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; return `${m}:${s.toString().padStart(2, '0')}`; }
  
  // H√†m updateUI gi·ªØ nguy√™n t·ª´ code g·ªëc, kh√¥ng c·∫ßn thay ƒë·ªïi g√¨.
  // N√≥ ch·ªâ ƒë∆°n gi·∫£n l√† ƒë·ªçc m·∫£ng `tasks` v√† v·∫Ω ra giao di·ªán.
    function updateUI() {
    // Task title
    const listCol = document.querySelector('.task-list-col');
    let taskTitle = document.getElementById('taskListTitle');
    if (!taskTitle) {
      taskTitle = document.createElement('div');
      taskTitle.className = "task-title";
      taskTitle.id = "taskListTitle";
      listCol.insertBefore(taskTitle, document.getElementById('taskList'));
    }
    taskTitle.innerHTML = "ƒêang t·∫£i xu·ªëng";
    taskTitle.style.display = (tasks.length > 0) ? 'block' : 'none';

    // Task list
    const list = document.getElementById('taskList');
    list.innerHTML = '';
    tasks.forEach((task, index) => {
      let timeStr = '';
      if (task.status === 'done' && task.startTime && task.finishTime) {
        let secs = (task.finishTime - task.startTime) / 1000;
        if (secs < 0) secs = 0;
        timeStr = `<span style="color:#8fc;"> (Ho√†n t·∫•t trong ${formatDuration(secs)})</span>`;
      } else if (task.status === 'processing' && task.startTime) {
        let secs = (Date.now() - task.startTime) / 1000;
        timeStr = `<span style="color:#bbb; font-size:11px;"> (${formatDuration(secs)})</span>`;
      }
      const div = document.createElement('div');
      div.className = 'task';
      div.innerHTML = `
        <div class="task-row">
          <span class="task-number">${index + 1}.</span>
          <span class="video-title">
            ${task.title
              ? `<a href="${task.url}" target="_blank" title="${task.title}">${task.title}</a>`
              : `ƒêang l·∫•y th√¥ng tin video...`}
          </span>
          <span class="video-duration">${task.duration ? secondsToHMS(task.duration) : ''}</span>
        </div>
        <div class="progress">
          <div class="progress-bar" style="width: ${task.progress}%"></div>
        </div>
        <div class="task-action-row">
          <span class="task-status-txt">
            ${
              task.status === 'done' ? 'Ho√†n t·∫•t!' + timeStr :
              task.status === 'error' ? `L·ªói: ${task.errorMsg || 'Kh√¥ng r√µ'}` :
              task.status === 'processing' ? (task.statusMsg || 'ƒêang x·ª≠ l√Ω...') + timeStr : ''
            }
          </span>
          ${
            task.status === 'done'
              ? (!task.downloaded
                  ? `<a class="download-link" href="${task.link}" download>
                      <button class="main-btn" onclick="markDownloaded(${index}, event)">üéß T·∫£i xu·ªëng</button>
                    </a>`
                  : `<button class="main-btn done" disabled>‚úÖ ƒê√£ t·∫£i xong</button>`)
              : task.status === 'error'
                ? `<button class="main-btn error" disabled>ƒê√≥ng</button>`
                : `<button class="main-btn cancel" onclick="cancelTask(${index})">‚ùå H·ªßy</button>`
          }
        </div>
      `;
      list.appendChild(div);
    });
  }
    function cancelTask(index) {
    const task = tasks[index];
    // G·ª≠i request h·ªßy job cho backend (n·∫øu c·∫ßn)
    fetch('https://api.takeshi.dev/cancel', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ url: task.url })
    });
    tasks.splice(index, 1);
    updateUI();
  }
  function markDownloaded(index, event) {
    setTimeout(() => {
      tasks[index].downloaded = true;
      updateUI();
    }, 700);
    if(event) event.stopPropagation();
  }
  async function searchVideo() {
    clearInputError();
    const urlInput = document.getElementById('url');
    const keyword = urlInput.value.trim();
    const searchResults = document.getElementById('searchResults');
    const searchResultsTitle = document.getElementById('searchResultsTitle');
    searchResults.innerHTML = '';
    searchResultsTitle.style.display = 'none';
    if (!keyword) { showInputError('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a!'); return; }
    if (isValidYoutubeURL(keyword)) { showInputError('Mu·ªën t·∫£i b·∫±ng link th√¨ b·∫•m "T·∫£i link"'); return; }
    searchResultsTitle.style.display = 'block';
    searchResults.innerHTML = `<li style="color:#ffe082; padding:10px 0 8px 6px;">üîé ƒêang t√¨m ki·∫øm...</li>`;
    try {
      const res = await fetch('https://api.takeshi.dev/search?q=' + encodeURIComponent(keyword));
      const list = await res.json();
      if (!list || !Array.isArray(list) || list.length === 0) {
        searchResults.innerHTML = `<li style="color:#fcafc8; padding:10px 0 8px 6px;">Kh√¥ng t√¨m th·∫•y video n√†o.</li>`;
        return;
      }
      searchResults.innerHTML = list.slice(0,10).map(v => `
        <li class="video-result-item" id="video_${v.id}">
          <img class="video-result-thumb" src="${v.thumbnail}" loading="lazy">
          <div class="video-result-info">
            <div class="video-result-title">${v.title}</div>
            <div class="video-result-duration">
              ${v.isLive ? '<span style="color:#ff5252;font-weight:600;">Tr·ª±c ti·∫øp</span>' : secondsToHMS(v.duration)}
            </div>
          </div>
          <button class="download-btn video-result-download" ${v.isLive ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''} onclick="tryAddTask('${v.url}','${v.id}',${!!v.isLive})">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          </button>
          <div class="video-warn" id="warn_${v.id}" style="display:none;color:#ffaaaa; font-size:12px; margin-top:2px;"></div>
        </li>
      `).join('');
    } catch {
      searchResults.innerHTML = `<li style="color:#fcafc8; padding:10px 0 8px 6px;">Kh√¥ng th·ªÉ t√¨m ki·∫øm l√∫c n√†y.</li>`;
    }
  }

    // Wrapper: N·∫øu l√† live, b√°o "Kh√¥ng th·ªÉ t·∫£i video tr·ª±c ti·∫øp!"
  function tryAddTask(url, videoId, isLive) {
    if (isLive) {
      showWarnUnderVideo(videoId, "Kh√¥ng th·ªÉ t·∫£i video tr·ª±c ti·∫øp!");
      return;
    }
    addTask(url, videoId);
  }
  // Show c·∫£nh b√°o ngay d∆∞·ªõi video ƒë√£ c√≥ trong danh s√°ch t·∫£i
  function showWarnUnderVideo(videoId, msg="Video n√†y ƒë√£ c√≥ trong danh s√°ch t·∫£i!") {
    if (activeWarn[videoId]) return;
    const warnDiv = document.getElementById('warn_' + videoId);
    if (warnDiv) {
      warnDiv.textContent = msg;
      warnDiv.style.display = "block";
      activeWarn[videoId] = true;
      setTimeout(() => {
        warnDiv.style.display = "none";
        warnDiv.textContent = "";
        activeWarn[videoId] = false;
      }, 3000);
    }
  }

  // Cho ph√©p b·∫•m Enter ƒë·ªÉ t√¨m ki·∫øm
  document.getElementById('url').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') searchVideo();
  });
  
  // L∆∞u √Ω: H√£y copy ƒë·∫ßy ƒë·ªß c√°c h√†m c√≤n thi·∫øu t·ª´ file g·ªëc v√†o ƒë√¢y ƒë·ªÉ ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông.
  // T√¥i ƒë√£ l∆∞·ª£c b·ªè ƒë·ªÉ cho c√¢u tr·∫£ l·ªùi ng·∫Øn g·ªçn.
  </script>
</body>
</html>